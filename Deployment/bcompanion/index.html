<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="description" content="A front-end template that helps you build fast, modern mobile web apps.">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
  <title>Профиль | BCompanion</title>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

  <!-- Add to homescreen for Chrome on Android -->
  <meta name="mobile-web-app-capable" content="yes">
  <link rel="icon" sizes="192x192" href="images/android-desktop.png">

  <!-- Add to homescreen for Safari on iOS -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="Material Design Lite">
  <link rel="apple-touch-icon-precomposed" href="images/ios-desktop.png">

  <!-- Tile icon for Win8 (144x144 + tile color) -->
  <meta name="msapplication-TileImage" content="images/touch/ms-touch-icon-144x144-precomposed.png">
  <meta name="msapplication-TileColor" content="#3372DF">
  <script defer src="https://code.getmdl.io/1.1.3/material.min.js"></script>
  <link rel="stylesheet" href="https://code.getmdl.io/1.1.3/material.orange-indigo.min.css">

  <link rel="stylesheet" href="css/style.css">
  <link rel="shortcut icon" href="images/favicon.png">

  <!-- SEO: If your mobile URL is different from the desktop URL, add a canonical link to the desktop page https://developers.google.com/webmasters/smartphone-sites/feature-phones -->
  <!--
    <link rel="canonical" href="http://www.example.com/">
    -->

  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css?family=Roboto:regular,bold,italic,thin,light,bolditalic,black,medium&amp;lang=en">
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.cyan-light_blue.min.css">
  <link rel="stylesheet" href="styles.css">

</head>

<body style="background-image: url('https://i.ibb.co/xXGb4Gq/bao.jpg'); background-repeat: no-repeat;
background-size: cover;">
  <div class="demo-layout mdl-layout mdl-js-layout mdl-layout--fixed-drawer ">

    <main style="margin-top: 200px;">
      <div class="mdl-grid demo-content">
        <div class="mdl-cell mdl-cell--12-col mdl-grid" style="opacity: 1;">
          <div class="loader"></div>
          <!-- Container for the sign in -->
          <div id="sign-in-card" style='display: none'
            class="mdl-card mdl-shadow--2dp mdl-cell mdl-cell--12-col mdl-cell--12-col-tablet mdl-cell--12-col-desktop">
            <div style="background-color: #6DC068 !important;"
              class="mdl-card__title mdl-color--light-blue-600 mdl-color-text--white">
              <h2 class="mdl-card__title-text" id='sign-in-card-text'>Введите номер телефона</h2>
            </div>
            <div class="mdl-card__supporting-text mdl-color-text--grey-600">
              <form id="sign-in-form" action="#">
                <!-- Input to enter the phone number -->
                <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                  <input class="mdl-textfield__input" type="text" pattern="\+[0-9\s\-\(\)]+" id="phone-number">
                  <label class="mdl-textfield__label" for="phone-number">Введите номер телефона...</label>
                  <span class="mdl-textfield__error">Вводимое значение должно начинаться с '+'</span>
                </div>

                <!-- Sign-in button -->
                <button disabled class="mdl-button mdl-js-button mdl-button--raised" id="sign-in-button">Отправить
                  код</button>
              </form>


              <form id="verification-code-form" action="#" style="display: none;">
                <!-- Input to enter the verification code -->
                <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                  <input class="mdl-textfield__input" type="text" id="verification-code">
                  <label class="mdl-textfield__label" for="verification-code">Введите код подтверждения...</label>
                  <span id="errortext" style="margin-top: 10px; color: red;"></span>
                </div>

                <!-- Button that triggers code verification -->
                <input type="submit" class="mdl-button mdl-js-button mdl-button--raised" id="verify-code-button"
                  value="Подтвердить" />
                <!-- Button to cancel code verification -->
                <button class="mdl-button mdl-js-button mdl-button--raised"
                  id="cancel-verify-code-button">Отмена</button>
              </form>
            </div>
          </div>
          <!-- Container for the sign up -->
          <div id="sign-up-card" style='display: none; margin-top: -100px;'
            class="mdl-card mdl-shadow--2dp mdl-cell mdl-cell--12-col mdl-cell--12-col-tablet mdl-cell--12-col-desktop">
            <div style="background-color: #6DC068 !important;"
              class="mdl-card__title mdl-color--light-blue-600 mdl-color-text--white">
              <h2 class="mdl-card__title-text" id='sign-in-card-text'>Зарегистрируйтесь</h2>
            </div>
            <div class="mdl-card__supporting-text mdl-color-text--grey-600">
              <form id="sign-in-form" action="#">
                <!-- Input to enter the name -->
                <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                  <input onKeyUp="check_val()" class="mdl-textfield__input" type="text" id="name" placeholder="Имя">
                </div>
                <!-- Input to enter the surname -->
                <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                  <input onKeyUp="check_val()" class="mdl-textfield__input" type="text" id="surname" placeholder="Фамилия">
                </div>
                <br>
                <!-- Input to enter the dateofbrith -->
                <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                  <input onKeyUp="check_val()" class="mdl-textfield__input" type="text" id="dateOfBirth"
                    placeholder="Дата рождения (00.00.00)">
                </div>
                <!-- Input to enter the city -->
                <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                  <input onKeyUp="check_val()" class="mdl-textfield__input" type="text" id="city" placeholder="Город, область">
                </div>
                <!-- Sign-in button -->
                <button class="mdl-button mdl-js-button mdl-button--raised" id="sign-up-button">Готово</button>
                <p id="bad_notice" style="color: red; margin-top: 20px"></p>
              </form>
            </div>
          </div>
          <!-- Main page -->
        </div>

        <!--Main page-->
      </div>
  </div>
  </div>
  </div>
  </main>

  </div>
  <script>
    function check_val() {
      var bad_words = new Array("террор", "террорист", "бляд", "говно", "долбоеб", "мудак", "охуеть", "пиздюк", "fuck", "terror", "terrorist");
      var check_text1 = document.getElementById("name").value;
      var check_text2 = document.getElementById("surname").value;
      var check_text3 = document.getElementById("city").value;

      var error = 0;
      for (var i = 0; i < bad_words.length; i++) {
        var val = bad_words[i];
        if ((check_text1.toLowerCase()).indexOf(val.toString()) > -1) {
          error = error + 1;
        }
      }
      for (var i = 0; i < bad_words.length; i++) {
        var val = bad_words[i];
        if ((check_text2.toLowerCase()).indexOf(val.toString()) > -1) {
          error = error + 1;
        }
      }
      for (var i = 0; i < bad_words.length; i++) {
        var val = bad_words[i];
        if ((check_text3.toLowerCase()).indexOf(val.toString()) > -1) {
          error = error + 1;
        }
      }
      if (error > 0) {
        document.getElementById("bad_notice").innerHTML = "Определены нецензурные слова!";
        $("#sign-up-button").fadeOut();
      } else {
        document.getElementById("bad_notice").innerHTML = "";
        $("#sign-up-button").fadeIn();
      }
    }
  </script>
  <script src="https://code.getmdl.io/1.3.0/material.min.js"></script>
  <!-- Insert these scripts at the bottom of the HTML, but before you use any Firebase services -->

  <!-- The core Firebase JS SDK is always required and must be listed first -->
  <script src="https://www.gstatic.com/firebasejs/7.14.2/firebase-app.js"></script>

  <!-- If you enabled Analytics in your project, add the Firebase SDK for Analytics -->
  <script src="https://www.gstatic.com/firebasejs/7.14.1/firebase-analytics.js"></script>

  <!-- Add Firebase products that you want to use -->
  <script src="https://www.gstatic.com/firebasejs/7.14.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.14.1/firebase-firestore.js"></script>

  <!-- TODO: Add SDKs for Firebase products that you want to use
     https://firebase.google.com/docs/web/setup#available-libraries -->

  <script>
    // Your web app's Firebase configuration
    var firebaseConfig = {
      apiKey: "AIzaSyABazjsZ1nHoNiP1KyjRRyMyjIqSJI8fHc",
      authDomain: "bcompanion-8fd26.firebaseapp.com",
      databaseURL: "https://bcompanion-8fd26.firebaseio.com",
      projectId: "bcompanion-8fd26",
      storageBucket: "bcompanion-8fd26.appspot.com",
      messagingSenderId: "430554304877",
      appId: "1:430554304877:web:56bcac9e7839d1cde90a64"
    };
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
  </script>

  <script type="text/javascript">
    /**
     * Set up UI event listeners and registering Firebase auth listeners.
     */
    window.onload = function () {
      var url = window.location.href;
      var params = (new URL(url)).searchParams;
      var logOut = params.get('logOut');
      console.log(logOut);
      if (logOut == 'true') {
        onSignOutClick();
        console.log('signed out');
      }
      // Listening for auth state changes.
      firebase.auth().onAuthStateChanged(function (user) {
        if (user) {
          // User is signed in.
          var uid = user.uid;
          var phoneNumber = user.phoneNumber;
        }
        updateSignInButtonUI();
        updateSignInFormUI();
        updateSignedInUserStatusUI();
        updateVerificationCodeFormUI();
      });
      // Event bindings.
      document.getElementById('phone-number').addEventListener('keyup', updateSignInButtonUI);
      document.getElementById('phone-number').addEventListener('change', updateSignInButtonUI);
      document.getElementById('verification-code').addEventListener('keyup', updateVerifyCodeButtonUI);
      document.getElementById('verification-code').addEventListener('change', updateVerifyCodeButtonUI);
      document.getElementById('verification-code-form').addEventListener('submit', onVerifyCodeSubmit);
      document.getElementById('cancel-verify-code-button').addEventListener('click', cancelVerification);
      // [START appVerifier]
      window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('sign-in-button', {
        'size': 'invisible',
        'callback': function (response) {
          // reCAPTCHA solved, allow signInWithPhoneNumber.
          onSignInSubmit();
        }
      });
      // [END appVerifier]
      recaptchaVerifier.render().then(function (widgetId) {
        window.recaptchaWidgetId = widgetId;
        updateSignInButtonUI();
      });
    };
    /**
     * Function called when clicking the Login/Logout button.
     */

    function onSignInSubmit() {
      if (isPhoneNumberValid()) {
        window.signingIn = true;
        updateSignInButtonUI();
        var phoneNumber = getPhoneNumberFromUserInput();
        var appVerifier = window.recaptchaVerifier;
        firebase.auth().signInWithPhoneNumber(phoneNumber, appVerifier)
          .then(function (confirmationResult) {
            // SMS sent. Prompt user to type the code from the message, then sign the
            // user in with confirmationResult.confirm(code).
            window.confirmationResult = confirmationResult;
            window.signingIn = false;
            updateSignInButtonUI();
            updateVerificationCodeFormUI();
            updateVerifyCodeButtonUI();
            updateSignInFormUI();
          }).catch(function (error) {
            // Error; SMS not sent
            console.error('Ошибка при авторизации signInWithPhoneNumber', error);
            window.alert('Ошибка при авторизации signInWithPhoneNumber:\n\n' +
              error.code + '\n\n' + error.message);
            window.signingIn = false;
            updateSignInFormUI();
            updateSignInButtonUI();
          });
      }
    }
    /**
     * Function called when clicking the "Verify Code" button.
     */
    function onVerifyCodeSubmit(e) {
      e.preventDefault();
      if (!!getCodeFromUserInput()) {
        window.verifyingCode = true;
        updateVerifyCodeButtonUI();
        var code = getCodeFromUserInput();
        confirmationResult.confirm(code).then(function (result) {
          // User signed in successfully.
          var user = result.user;
          window.verifyingCode = false;
          window.confirmationResult = null;
          updateVerificationCodeFormUI();
        }).catch(function (error) {
          // User couldn't sign in (bad verification code?)
          console.error('Ошибка проверки кода', error);
          $('#errortext').text("Ошибка проверки кода");
          window.verifyingCode = false;
          updateSignInButtonUI();
          updateVerifyCodeButtonUI();
        });
      }
    }
    /**
     * Cancels the verification code input.
     */
    function cancelVerification(e) {
      e.preventDefault();
      window.confirmationResult = null;
      updateVerificationCodeFormUI();
      updateSignInFormUI();
    }
    /**
     * Signs out the user when the sign-out button is clicked.
     */
    function onSignOutClick() {
      firebase.auth().signOut();
      $('#sign-up-card').fadeOut();
    }
    /**
     * Reads the verification code from the user input.
     */
    function getCodeFromUserInput() {
      return document.getElementById('verification-code').value;
    }
    /**
     * Reads the phone number from the user input.
     */
    function getPhoneNumberFromUserInput() {
      return document.getElementById('phone-number').value;
    }
    /**
     * Returns true if the phone number is valid.
     */
    function isPhoneNumberValid() {
      var pattern = /^\+[0-9\s\-\(\)]+$/;
      var phoneNumber = getPhoneNumberFromUserInput();
      return phoneNumber.search(pattern) !== -1;
    }
    /**
     * Re-initializes the ReCaptacha widget.
     */
    function resetReCaptcha() {
      if (typeof grecaptcha !== 'undefined' &&
        typeof window.recaptchaWidgetId !== 'undefined') {
        grecaptcha.reset(window.recaptchaWidgetId);
      }
    }
    /**
     * Updates the Sign-in button state depending on ReCAptcha and form values state.
     */
    function updateSignInButtonUI() {
      document.getElementById('sign-in-button').disabled = !isPhoneNumberValid() ||
        !!window.signingIn;
    }
    /**
     * Updates the Verify-code button state depending on form values state.
     */
    function updateVerifyCodeButtonUI() {
      document.getElementById('verify-code-button').disabled = !!window.verifyingCode ||
        !getCodeFromUserInput();
    }
    /**
     * Updates the state of the Sign-in form.
     */
    function updateSignInFormUI() {
      if (firebase.auth().currentUser || window.confirmationResult) {
        document.getElementById('sign-in-form').style.display = 'none';
      } else {
        resetReCaptcha();
        document.getElementById('sign-in-form').style.display = 'block';
      }
    }
    /**
     * Updates the state of the Verify code form.
     */
    function updateVerificationCodeFormUI() {
      if (!firebase.auth().currentUser && window.confirmationResult) {
        document.getElementById('verification-code-form').style.display = 'block';
        $('#sign-in-card-text').text('Введите код подтверждения');
      } else {
        document.getElementById('verification-code-form').style.display = 'none';
      }
    }
    /**
     * Updates the state of the Sign out button.
     */

    /**
     * Updates the Signed in user status panel.
     */
    function updateSignedInUserStatusUI() {
      var user = firebase.auth().currentUser;
      var $userInfo = $('#account-details');
      if (user) {
        $('#sign-in-card').fadeOut();

        $(function () {

          $.ajax({
            type: 'GET',
            url: 'https://stormy-escarpment-89406.herokuapp.com/users/getUser?phone_number=' +
              encodeURIComponent(user.phoneNumber),
            beforeSend: function () {
              // Show image container
              $(".loader").show();
            },
            success: function (data) {
              console.log("User exists and success! Redirecting...");
              window.location = 'app.html?phoneNum=' + encodeURIComponent(user.phoneNumber);
            },
            complete: function (data) {
              // Hide image container
              $(".loader").hide();
            },
            error: function (error) {
              $("#sign-up-card").fadeIn();
            }
          })
        });
        $('#sign-up-button').click(function () {
          var name = document.getElementById("name").value;
          var surname = document.getElementById("surname").value;
          var dateOfBirth = document.getElementById("dateOfBirth").value;
          var city = document.getElementById("city").value;


          var phoneNumber = user.phoneNumber;
          var someData = {
            "name": name,
            "surname": surname,
            "phoneNumber": phoneNumber,
            "dateOfBirth": dateOfBirth,
            "city": city
          };

          $(function () {
            $.ajax({
              type: 'POST',
              data: JSON.stringify(someData),
              url: 'https://stormy-escarpment-89406.herokuapp.com/users/authorize?auth_type=registration',
              beforeSend: function () {
                // Show image container
                $(".loader").show();
              },
              success: function (data, textStatus, jqXHR) {
                console.log("User registered and success! Redirecting...");
                window.location = 'app.html?phoneNum=' + encodeURIComponent(user.phoneNumber);
              },
              complete: function (data) {
                // Hide image container
                $(".loader").hide();
                window.location = 'app.html?phoneNum=' + encodeURIComponent(user.phoneNumber);

              },
              error: function (jqXHR, textStatus, errorThrown) {
                $('#errortext').text('Error');
                window.location = 'app.html?phoneNum=' + encodeURIComponent(user.phoneNumber);
              }
            })
          });
          window.location = 'app.html?phoneNum=' + encodeURIComponent(user.phoneNumber);

        });
      } else {
        $('#sign-in-card').fadeIn();
        $('#mainPageText').text('Авторизуйтесь');
        $('#account-details').text('');
        $('#page').fadeOut();
        $(".loader").hide();
      }

    }
  </script>
</body>

</html>
